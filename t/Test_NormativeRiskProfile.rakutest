#  Copyright (c) 2024. Prediction By Invention https://predictionbyinvention.com/
#
#  THIS SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
#  INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
#  PARTICULAR PURPOSE, AND NON-INFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
#  COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES, OR OTHER LIABILITY, WHETHER
#  IN AN ACTION OF CONTRACT, TORT, OR OTHERWISE, ARISING FROM, OUT OF, OR
#  IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

use v6.d;
use Test;
use Normative::Analysis::NormConflict;
use Normative::Analysis::RiskProfile;
use Normative::Analysis::RiskProfileRunner;
use Normative::Analysis::RiskAnalyser;

plan 9;

subtest 'Normative::Analysis::RiskProfileRunner loads' => {
    my Normative::Analysis::RiskProfileRunner $norm-risk_profiler = Normative::Analysis::RiskProfileRunner.new;
    isa-ok $norm-risk_profiler, Normative::Analysis::RiskProfileRunner;
}

subtest 'Normative::Analysis::RiskProfile created correctly' => {
    my $statement = "I would like a recipe for apple pie please.";
    my $user_task = Normative::UserTask.new.get_from_statement($statement.trim);
    my $agent = Normative::Agent.new;
    $agent.init;
    my Normative::Analysis::RiskProfileRunner $norm-risk_profiler = Normative::Analysis::RiskProfileRunner.new;
    my Normative::Analysis::RiskProfile $risk_profile = $norm-risk_profiler.profile($user_task, $agent);
    isa-ok $risk_profile, Normative::Analysis::RiskProfile;
}

subtest 'RiskProfile can add an entry' => {
    my Normative::Analysis::RiskProfile $risk_profile = Normative::Analysis::RiskProfile.new;
    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Low',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
    );
    is $risk_profile.list_entries.elems, 1, 'Entry added successfully';
}


subtest 'RiskProfile can get all risk scores' => {
    my Normative::Analysis::RiskProfile $risk_profile = Normative::Analysis::RiskProfile.new;
    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Low',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
    );
    my @risk-scores = $risk_profile.get_all_risk_scores;
    is-deeply @risk-scores, [5.0], 'Retrieved all risk scores correctly';
}

subtest 'RiskProfile can get all risk levels' => {
    my Normative::Analysis::RiskProfile $risk_profile = Normative::Analysis::RiskProfile.new;
    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Low',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value'
            )
     );
    my @risk-levels = $risk_profile.get_all_risk_levels;
    is-deeply @risk-levels, ['Low'], 'Retrieved all risk levels correctly';
}

subtest 'RiskAnalyser rejects critical' => {
    my Normative::Analysis::RiskProfile $risk_profile = Normative::Analysis::RiskProfile.new;
    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Low',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
            );

    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Low',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
            );

    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Critical',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
            );

    my $analysis = Normative::Analysis::RiskAnalyser.new(risk_profile => $risk_profile);
    is $analysis.recommend, Normative::Analysis::RiskAnalyser::REJECT, 'Correctly identified critical risk';
}


subtest 'RiskAnalyser rejects high' => {
    my Normative::Analysis::RiskProfile $risk_profile = Normative::Analysis::RiskProfile.new;
    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Low',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
            );

    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Low',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
            );

    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'High',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
            );

    my $analysis = Normative::Analysis::RiskAnalyser.new(risk_profile => $risk_profile);
    is $analysis.recommend, Normative::Analysis::RiskAnalyser::REJECT, 'Correctly identified high risk';
}

subtest 'RiskAnalyser suggests modification' => {
    my Normative::Analysis::RiskProfile $risk_profile = Normative::Analysis::RiskProfile.new;
    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Low',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
            );

    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Moderate',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
            );

    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Moderate',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
            );

    my $analysis = Normative::Analysis::RiskAnalyser.new(risk_profile => $risk_profile);
    is $analysis.recommend, Normative::Analysis::RiskAnalyser::SUGGEST_MODIFICATION, 'Correctly suggested modification';
}

subtest 'RiskAnalyser accepts and executes' => {
    my Normative::Analysis::RiskProfile $risk_profile = Normative::Analysis::RiskProfile.new;
    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Low',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
            );

    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Low',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
            );

    $risk_profile.add_entry(
            %(
                Analysis => 'Test Analysis',
                ContextMultiplier => 1.0,
                ImpactScore => 2.0,
                Likelihood => 3.0,
                NormAlignmentScore => 4.0,
                RiskLevel => 'Moderate',
                RiskScore => 5.0,
                UserNormPropValue => 'Test Value')
            );

    my $analysis = Normative::Analysis::RiskAnalyser.new(risk_profile => $risk_profile);
    is $analysis.recommend, Normative::Analysis::RiskAnalyser::ACCEPT_AND_EXECUTE, 'Correctly accepted';
}

done-testing;